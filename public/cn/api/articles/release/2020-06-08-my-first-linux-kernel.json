{"title":"编写我的第一个Linux 内核模块“hello_module","slug":"release/2020-06-08-my-first-linux-kernel","date":"2020-06-09T16:00:00.000Z","updated":"2020-06-09T16:00:00.000Z","comments":true,"path":"api/articles/release/2020-06-08-my-first-linux-kernel.json","excerpt":"前言： Linux 内 核 模 块 全 称 为 “ 动 态 可 加 载 内 核 模 块 (Loadable Kernel Module,LKM)”，是系统内核向外部提供的功能插口。作为宏内核结构，Linux 内核具有效率高的特点，但也有可扩展性和可维护性相对较差的不足，Linux 提供模块机制正是弥补这一缺陷。 模块是具有独立功能的程序，它可以被单独编译，但不能独立运行。模块在运行时被链接到内核作为内核的一部分在内核空间运行，这与运行在用户控件的进程是不同的。模块通常有一组函数和数据结构组成，用来实现某种文件系统、驱动程序或其它内核上层功能。 本文将介绍如何编写一个简单的内核模块以及如何传递参数给此模块。 一、 编写一个简单的内核模块1.编写模块程序编写如下简单代码，本示例中代码文件命名“hello_module.c”。 123456789101112131415161718192021//hello_module.c#include &lt;linux/module.h&gt;#include &lt;linux/kernel.h&gt;#include &lt;linux/init","covers":["/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvZ1VlVzN0N0lQaWRPMkdyLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvOXg4MVBSd21pWERZdVFaLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvUHNMdVJGSGlNTzZRbXJYLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvRE9GTXp1dHNtS3BuWUxhLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvM1NQVXhhbXFpQ2R2T0dGLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvSFlVTU5ramJHbW82Q252LnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNzVqdWdBcE9XRVNNeWFULnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvSkM3bnBWa3h2RXNoR2xXLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvdlJVSkZsemptdVNpSURyLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvV1p0QlZEQ1g3R25SZTlsLnBuZw","/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvZjdXNnF0ZGtVRDRPTDlvLnBuZw"],"content":"<blockquote>\n<p> 前言：</p>\n<p> Linux 内 核 模 块 全 称 为 “ 动 态 可 加 载 内 核 模 块 (Loadable Kernel Module,LKM)”，是系统内核向外部提供的功能插口。作为宏内核结构，Linux 内核具有效率高的特点，但也有可扩展性和可维护性相对较差的不足，Linux 提供模块机制正是弥补这一缺陷。</p>\n<p> 模块是具有独立功能的程序，它可以被单独编译，但不能独立运行。模块在运行时被链接到内核作为内核的一部分在内核空间运行，这与运行在用户控件的进程是不同的。模块通常有一组函数和数据结构组成，用来实现某种文件系统、驱动程序或其它内核上层功能。 </p>\n<p> 本文将介绍如何编写一个简单的内核模块以及如何传递参数给此模块。 </p>\n</blockquote>\n<h4 id=\"一、-编写一个简单的内核模块\"><a href=\"#一、-编写一个简单的内核模块\" class=\"headerlink\" title=\"一、 编写一个简单的内核模块\"></a>一、 编写一个简单的内核模块</h4><h5 id=\"1-编写模块程序\"><a href=\"#1-编写模块程序\" class=\"headerlink\" title=\"1.编写模块程序\"></a>1.编写模块程序</h5><p>编写如下简单代码，本示例中代码文件命名“hello_module.c”。 </p>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//hello_module.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/module.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/kernel.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/init.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __init <span class=\"title function_\">hello_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>{</span><br><span class=\"line\">   printk(<span class=\"string\">\"This is hello_module, welcome to Linux kernel \\n\"</span>);</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __exit <span class=\"title function_\">hello_exit</span><span class=\"params\">(<span class=\"type\">void</span>)</span>{</span><br><span class=\"line\">   printk(<span class=\"string\">\"see you next time!\\n\"</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\">module_init(hello_init);</span><br><span class=\"line\">module_exit(hello_exit);</span><br><span class=\"line\"></span><br><span class=\"line\">MODULE_LICENSE(<span class=\"string\">\"GPL\"</span>);</span><br><span class=\"line\">MODULE_AUTHOR(<span class=\"string\">\"Mr Q\"</span>);</span><br><span class=\"line\">MODULE_DESCRIPTION(<span class=\"string\">\"hello kernel module\"</span>);</span><br><span class=\"line\">MODULE_ALIAS(<span class=\"string\">\"hello\"</span>);</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>以上代码解释如下:</p>\n<p>（1） #include &lt;linux/module.h&gt;：必须。module.h 头文件包含了对模块的结构定义以及模块的版本控制，任何模块程序的编写都要包含这个头文件；</p>\n<p>（2） #include &lt;linux/kernel.h&gt;：kernel.h 包含了常用的内核函数，如以上程序中的 printk()函数；</p>\n<p>（3） #include &lt;linux/init.h&gt;：必须。init.h 包含了 module_init()和 module_exit()函数的声明；</p>\n<p>（4） module_init()：必须。模块加载函数，加载模块式该函数自动执行，进行初始化操作；</p>\n<p>（5） module_exit()：必须。模块卸载函数，卸载模块时函数自动执行，进行清理操作；</p>\n<p>（6） MODULE_LICENSE():表示模块代码接受的软件许可协议。Linux 内核是使用 GPL V2 的开源项目，其要求所有使用和修改了 Linux 内核代码的个人或组织都有义务把修改后的源代码公开，这是一个强制的开源协议，所以一般编写驱动代码都需要显示的声明和遵循本协议，否则内核 UI 发出被污染的警告；</p>\n<p>（7） MODULE_AUTHOR():描述模块的作者信息；</p>\n<p>（8） MODULE_DESCRIPTION():简单描述模块的用途、功能介绍等；</p>\n<p>（9） MODULE_ALIAS():为用户控件提供的别名；</p>\n<p>（10） printk():内核输出函数，默认打印系统文件 “ /var/log/kern.log”的内容。  </p>\n</blockquote>\n<h5 id=\"2-编译内核模块\"><a href=\"#2-编译内核模块\" class=\"headerlink\" title=\"2. 编译内核模块\"></a>2. 编译内核模块</h5><p>编写 Makefile 文件，文件名必须为“Makefile”  </p>\n<figure class=\"highlight makefile\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">obj-m := hello_module.o</span><br><span class=\"line\"></span><br><span class=\"line\">KERNELBUILD := /lib/modules/<span class=\"variable\">$(<span class=\"built_in\">shell</span> uname -r)</span>/build</span><br><span class=\"line\">CURRENT_PATH := <span class=\"variable\">$(<span class=\"built_in\">shell</span> pwd)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">all:</span></span><br><span class=\"line\">\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> modules</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">clean:</span></span><br><span class=\"line\">\t\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>以上代码解释如下:</p>\n<p>（1） obj-m := &lt;模块名&gt;.o：定义要生成的模块名称</p>\n<p>（2） KERNELBUILD := /lib/modules/$(shell uname -r)/build ：</p>\n<p>KERNELBUILD 为自定义名称，用于指向正在运行 Linux 的内核编译目录，其中“uname -r”标识显示对应的内核版本；</p>\n<p>（3） CURRENT_PATH := $(shell pwd)：CURRENT_PATH 为自定义名称，用于指向当前当前目录；</p>\n<p>（4） all:编译执行的动作</p>\n<p>（5） clean:zhixing make clean 需要的动作。“make clean”用于清除上次的 make 命令所产生的 object 文件（后缀为“.o”的文件）及可执行文件。    </p>\n</blockquote>\n<h5 id=\"3-编译\"><a href=\"#3-编译\" class=\"headerlink\" title=\"3.编译\"></a>3.编译</h5><p>将以上两个文件(hello_module.c 和 Makefile)保存于同一目录下，将上文中代码存放在路径为“/code/hellomodule/”，编译需在文件保存目录中进行。  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvZ1VlVzN0N0lQaWRPMkdyLnBuZw\" alt=\"image-20200608113407988\"></p>\n<p>编译成功后，可看到生成的 hello_module.ko 目标文件  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvOXg4MVBSd21pWERZdVFaLnBuZw\" alt=\"image-20200608113502338\"></p>\n<h5 id=\"4-检查编译模块\"><a href=\"#4-检查编译模块\" class=\"headerlink\" title=\"4.检查编译模块\"></a>4.检查编译模块</h5><p>可通过 file 命令检查编译的模块是否正确，可以看到 x86-64 架构的 elf文件，说明编译成功:</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvUHNMdVJGSGlNTzZRbXJYLnBuZw\" alt=\"image-20200608113816662\">  </p>\n<p>也可通过 modinfo 命令进一步检查 :</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvRE9GTXp1dHNtS3BuWUxhLnBuZw\" alt=\"image-20200608114046227\"></p>\n<h5 id=\"5-插入模块\"><a href=\"#5-插入模块\" class=\"headerlink\" title=\"5.插入模块\"></a>5.插入模块</h5><p>通过 insmod 命令插入模块，完成插入后可通过 lsmod 命令查看当前模块是否已经被加载到系统中:</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvM1NQVXhhbXFpQ2R2T0dGLnBuZw\" alt=\"image-20200608115103707\"></p>\n<p>系统加载模块后，也会在“/sys/module”目录下新建以模块名命名的目录 :</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvSFlVTU5ramJHbW82Q252LnBuZw\" alt=\"image-20200608115252879\"></p>\n<h5 id=\"6-查看输出\"><a href=\"#6-查看输出\" class=\"headerlink\" title=\"6.查看输出\"></a>6.查看输出</h5><p>   因 本 演示 中 prink()采 用 默认 输出 等级 ，可 通 过“ dmesg” 或“ tail /var/log/kern.log”命令查看输出结果。  </p>\n<p>   <img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNzVqdWdBcE9XRVNNeWFULnBuZw\" alt=\"image-20200608115615691\"></p>\n<p>“  tail /var/log/kern.log”命令查看输出结果：</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvSkM3bnBWa3h2RXNoR2xXLnBuZw\" alt=\"image-20200608115832820\"></p>\n<h5 id=\"7-卸载模块\"><a href=\"#7-卸载模块\" class=\"headerlink\" title=\"7. 卸载模块\"></a>7. 卸载模块</h5><p>   卸载模块，可通过“rmmod 模块名”实现，通 过“ tail /var/log/kern.log”命令查看输出结果。  </p>\n<p>   <img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvdlJVSkZsemptdVNpSURyLnBuZw\" alt=\"image-20200608120215696\"></p>\n<h4 id=\"二、-模块参数\"><a href=\"#二、-模块参数\" class=\"headerlink\" title=\"二、 模块参数\"></a>二、 模块参数</h4><h5 id=\"1-说明\"><a href=\"#1-说明\" class=\"headerlink\" title=\"1.说明\"></a>1.说明</h5><p>Linux 内核提供一个宏来实现模块的参数传递</p>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> module_param(name, type, perm) \\</span></span><br><span class=\"line\"><span class=\"meta\">module_param_named(name, name, type, perm)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MODULE_PARM_DESC(_parm, desc) \\</span></span><br><span class=\"line\"><span class=\"meta\">_MODULE_INFO(parm, _parm, #_parm <span class=\"string\">\":\"</span> desc);</span></span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>module_param()宏由 3 个参数组成，name 表示参数名，type 表示参数类型，perm 表示参数读写权限。MODULE_PARM_DESC()宏提供参数的简单说明，参数类型可为 byte、short、int、long、char、bool 等类型；perm 指定在 sysfs 中相应文件的访问权限，如设置为 0 则不会出现在 sysfs 文件系统中，设置为 0644 标识 root 用户可修改本参数。  </p>\n</blockquote>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> debug = <span class=\"number\">1</span>;</span><br><span class=\"line\">module_param(debug, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\">MODULE_PARM_DESC(debug, <span class=\"string\">\"enable debugging information\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> dprintk(args...) <span class=\"keyword\">if</span>(debug){printk(KERN_DEBUG args);}</span></span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>如上述实际代码所示（driver/misc/altera-stap1/altera.c），实际定义模块参数 debug,类型是 int,访问权限是 0644。参数用途是大概调试信息，实际内核编程中常用此方法进行内核调试。  </p>\n</blockquote>\n<h5 id=\"2-开始动手\"><a href=\"#2-开始动手\" class=\"headerlink\" title=\"2.开始动手\"></a>2.开始动手</h5><p>修改上文中的“hello_module.c”文件，改为以下内容：</p>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//hello_module.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/module.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/kernel.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/init.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> debug = <span class=\"number\">1</span>;</span><br><span class=\"line\">module_param(debug, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\">MODULE_PARM_DESC(debug, <span class=\"string\">\"debugging information\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> dprintk(args...) <span class=\"keyword\">if</span>(debug){printk(KERN_DEBUG args);}</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> myparm = <span class=\"number\">10</span>;</span><br><span class=\"line\">module_param(myparm, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\">MODULE_PARM_DESC(myparm, <span class=\"string\">\"kernel module parameter experiment.\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __init <span class=\"title function_\">parm_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>{</span><br><span class=\"line\">   dprintk(<span class=\"string\">\"my linux kernel module init.\\n\"</span>);</span><br><span class=\"line\">   dprintk(<span class=\"string\">\"module parameter = %d\\n\"</span>, myparm);</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __exit <span class=\"title function_\">parm_exit</span><span class=\"params\">(<span class=\"type\">void</span>)</span>{</span><br><span class=\"line\">   printk(<span class=\"string\">\"see you next time!\\n\"</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\">module_init(parm_init);</span><br><span class=\"line\">module_exit(parm_exit);</span><br><span class=\"line\"></span><br><span class=\"line\">MODULE_LICENSE(<span class=\"string\">\"GPL\"</span>);</span><br><span class=\"line\">MODULE_AUTHOR(<span class=\"string\">\"Mr Q\"</span>);</span><br><span class=\"line\">MODULE_DESCRIPTION(<span class=\"string\">\"kernel module paramter experiment\"</span>);</span><br><span class=\"line\">MODULE_ALIAS(<span class=\"string\">\"myparm\"</span>);</span><br></pre></td></tr></tbody></table></figure>\n\n<p>make编译，装载模块，并查看输出:</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvV1p0QlZEQ1g3R25SZTlsLnBuZw\" alt=\"image-20200608122047862\"></p>\n<blockquote>\n<p>通过查看日志信息，可发现输出以上程序中 参数 的默认值。  </p>\n</blockquote>\n<p>卸载模块，赋值重新加载模块,修改参数 myparm 值为 116：  </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insmod parm_module.ko myparm=116  </span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvZjdXNnF0ZGtVRDRPTDlvLnBuZw\" alt=\"image-20200608122350054\"></p>\n<blockquote>\n<p>通过查看日志信息，可发现 参数 值已经改变。  </p>\n</blockquote>\n","more":"<blockquote>\n<p> 前言：</p>\n<p> Linux 内 核 模 块 全 称 为 “ 动 态 可 加 载 内 核 模 块 (Loadable Kernel Module,LKM)”，是系统内核向外部提供的功能插口。作为宏内核结构，Linux 内核具有效率高的特点，但也有可扩展性和可维护性相对较差的不足，Linux 提供模块机制正是弥补这一缺陷。</p>\n<p> 模块是具有独立功能的程序，它可以被单独编译，但不能独立运行。模块在运行时被链接到内核作为内核的一部分在内核空间运行，这与运行在用户控件的进程是不同的。模块通常有一组函数和数据结构组成，用来实现某种文件系统、驱动程序或其它内核上层功能。 </p>\n<p> 本文将介绍如何编写一个简单的内核模块以及如何传递参数给此模块。 </p>\n</blockquote>\n<h4 id=\"一、-编写一个简单的内核模块\"><a href=\"#一、-编写一个简单的内核模块\" class=\"headerlink\" title=\"一、 编写一个简单的内核模块\"></a>一、 编写一个简单的内核模块</h4><h5 id=\"1-编写模块程序\"><a href=\"#1-编写模块程序\" class=\"headerlink\" title=\"1.编写模块程序\"></a>1.编写模块程序</h5><p>编写如下简单代码，本示例中代码文件命名“hello_module.c”。 </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//hello_module.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/module.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/kernel.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/init.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __init <span class=\"title function_\">hello_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>&#123;</span><br><span class=\"line\">   printk(<span class=\"string\">&quot;This is hello_module, welcome to Linux kernel \\n&quot;</span>);</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __exit <span class=\"title function_\">hello_exit</span><span class=\"params\">(<span class=\"type\">void</span>)</span>&#123;</span><br><span class=\"line\">   printk(<span class=\"string\">&quot;see you next time!\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">module_init(hello_init);</span><br><span class=\"line\">module_exit(hello_exit);</span><br><span class=\"line\"></span><br><span class=\"line\">MODULE_LICENSE(<span class=\"string\">&quot;GPL&quot;</span>);</span><br><span class=\"line\">MODULE_AUTHOR(<span class=\"string\">&quot;Mr Q&quot;</span>);</span><br><span class=\"line\">MODULE_DESCRIPTION(<span class=\"string\">&quot;hello kernel module&quot;</span>);</span><br><span class=\"line\">MODULE_ALIAS(<span class=\"string\">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以上代码解释如下:</p>\n<p>（1） #include &lt;linux/module.h&gt;：必须。module.h 头文件包含了对模块的结构定义以及模块的版本控制，任何模块程序的编写都要包含这个头文件；</p>\n<p>（2） #include &lt;linux/kernel.h&gt;：kernel.h 包含了常用的内核函数，如以上程序中的 printk()函数；</p>\n<p>（3） #include &lt;linux/init.h&gt;：必须。init.h 包含了 module_init()和 module_exit()函数的声明；</p>\n<p>（4） module_init()：必须。模块加载函数，加载模块式该函数自动执行，进行初始化操作；</p>\n<p>（5） module_exit()：必须。模块卸载函数，卸载模块时函数自动执行，进行清理操作；</p>\n<p>（6） MODULE_LICENSE():表示模块代码接受的软件许可协议。Linux 内核是使用 GPL V2 的开源项目，其要求所有使用和修改了 Linux 内核代码的个人或组织都有义务把修改后的源代码公开，这是一个强制的开源协议，所以一般编写驱动代码都需要显示的声明和遵循本协议，否则内核 UI 发出被污染的警告；</p>\n<p>（7） MODULE_AUTHOR():描述模块的作者信息；</p>\n<p>（8） MODULE_DESCRIPTION():简单描述模块的用途、功能介绍等；</p>\n<p>（9） MODULE_ALIAS():为用户控件提供的别名；</p>\n<p>（10） printk():内核输出函数，默认打印系统文件 “ /var/log/kern.log”的内容。  </p>\n</blockquote>\n<h5 id=\"2-编译内核模块\"><a href=\"#2-编译内核模块\" class=\"headerlink\" title=\"2. 编译内核模块\"></a>2. 编译内核模块</h5><p>编写 Makefile 文件，文件名必须为“Makefile”  </p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">obj-m := hello_module.o</span><br><span class=\"line\"></span><br><span class=\"line\">KERNELBUILD := /lib/modules/<span class=\"variable\">$(<span class=\"built_in\">shell</span> uname -r)</span>/build</span><br><span class=\"line\">CURRENT_PATH := <span class=\"variable\">$(<span class=\"built_in\">shell</span> pwd)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">all:</span></span><br><span class=\"line\">\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> modules</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">clean:</span></span><br><span class=\"line\">\t\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以上代码解释如下:</p>\n<p>（1） obj-m := &lt;模块名&gt;.o：定义要生成的模块名称</p>\n<p>（2） KERNELBUILD := /lib/modules/$(shell uname -r)/build ：</p>\n<p>KERNELBUILD 为自定义名称，用于指向正在运行 Linux 的内核编译目录，其中“uname -r”标识显示对应的内核版本；</p>\n<p>（3） CURRENT_PATH := $(shell pwd)：CURRENT_PATH 为自定义名称，用于指向当前当前目录；</p>\n<p>（4） all:编译执行的动作</p>\n<p>（5） clean:zhixing make clean 需要的动作。“make clean”用于清除上次的 make 命令所产生的 object 文件（后缀为“.o”的文件）及可执行文件。    </p>\n</blockquote>\n<h5 id=\"3-编译\"><a href=\"#3-编译\" class=\"headerlink\" title=\"3.编译\"></a>3.编译</h5><p>将以上两个文件(hello_module.c 和 Makefile)保存于同一目录下，将上文中代码存放在路径为“/code/hellomodule/”，编译需在文件保存目录中进行。  </p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvZ1VlVzN0N0lQaWRPMkdyLnBuZw\" alt=\"image-20200608113407988\"></p>\n<p>编译成功后，可看到生成的 hello_module.ko 目标文件  </p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvOXg4MVBSd21pWERZdVFaLnBuZw\" alt=\"image-20200608113502338\"></p>\n<h5 id=\"4-检查编译模块\"><a href=\"#4-检查编译模块\" class=\"headerlink\" title=\"4.检查编译模块\"></a>4.检查编译模块</h5><p>可通过 file 命令检查编译的模块是否正确，可以看到 x86-64 架构的 elf文件，说明编译成功:</p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvUHNMdVJGSGlNTzZRbXJYLnBuZw\" alt=\"image-20200608113816662\">  </p>\n<p>也可通过 modinfo 命令进一步检查 :</p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvRE9GTXp1dHNtS3BuWUxhLnBuZw\" alt=\"image-20200608114046227\"></p>\n<h5 id=\"5-插入模块\"><a href=\"#5-插入模块\" class=\"headerlink\" title=\"5.插入模块\"></a>5.插入模块</h5><p>通过 insmod 命令插入模块，完成插入后可通过 lsmod 命令查看当前模块是否已经被加载到系统中:</p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvM1NQVXhhbXFpQ2R2T0dGLnBuZw\" alt=\"image-20200608115103707\"></p>\n<p>系统加载模块后，也会在“/sys/module”目录下新建以模块名命名的目录 :</p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvSFlVTU5ramJHbW82Q252LnBuZw\" alt=\"image-20200608115252879\"></p>\n<h5 id=\"6-查看输出\"><a href=\"#6-查看输出\" class=\"headerlink\" title=\"6.查看输出\"></a>6.查看输出</h5><p>   因 本 演示 中 prink()采 用 默认 输出 等级 ，可 通 过“ dmesg” 或“ tail /var/log/kern.log”命令查看输出结果。  </p>\n<p>   <img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNzVqdWdBcE9XRVNNeWFULnBuZw\" alt=\"image-20200608115615691\"></p>\n<p>“  tail /var/log/kern.log”命令查看输出结果：</p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvSkM3bnBWa3h2RXNoR2xXLnBuZw\" alt=\"image-20200608115832820\"></p>\n<h5 id=\"7-卸载模块\"><a href=\"#7-卸载模块\" class=\"headerlink\" title=\"7. 卸载模块\"></a>7. 卸载模块</h5><p>   卸载模块，可通过“rmmod 模块名”实现，通 过“ tail /var/log/kern.log”命令查看输出结果。  </p>\n<p>   <img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvdlJVSkZsemptdVNpSURyLnBuZw\" alt=\"image-20200608120215696\"></p>\n<h4 id=\"二、-模块参数\"><a href=\"#二、-模块参数\" class=\"headerlink\" title=\"二、 模块参数\"></a>二、 模块参数</h4><h5 id=\"1-说明\"><a href=\"#1-说明\" class=\"headerlink\" title=\"1.说明\"></a>1.说明</h5><p>Linux 内核提供一个宏来实现模块的参数传递</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> module_param(name, type, perm) \\</span></span><br><span class=\"line\"><span class=\"meta\">module_param_named(name, name, type, perm)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MODULE_PARM_DESC(_parm, desc) \\</span></span><br><span class=\"line\"><span class=\"meta\">_MODULE_INFO(parm, _parm, #_parm <span class=\"string\">&quot;:&quot;</span> desc);</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>module_param()宏由 3 个参数组成，name 表示参数名，type 表示参数类型，perm 表示参数读写权限。MODULE_PARM_DESC()宏提供参数的简单说明，参数类型可为 byte、short、int、long、char、bool 等类型；perm 指定在 sysfs 中相应文件的访问权限，如设置为 0 则不会出现在 sysfs 文件系统中，设置为 0644 标识 root 用户可修改本参数。  </p>\n</blockquote>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> debug = <span class=\"number\">1</span>;</span><br><span class=\"line\">module_param(debug, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\">MODULE_PARM_DESC(debug, <span class=\"string\">&quot;enable debugging information&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> dprintk(args...) <span class=\"keyword\">if</span>(debug)&#123;printk(KERN_DEBUG args);&#125;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如上述实际代码所示（driver/misc/altera-stap1/altera.c），实际定义模块参数 debug,类型是 int,访问权限是 0644。参数用途是大概调试信息，实际内核编程中常用此方法进行内核调试。  </p>\n</blockquote>\n<h5 id=\"2-开始动手\"><a href=\"#2-开始动手\" class=\"headerlink\" title=\"2.开始动手\"></a>2.开始动手</h5><p>修改上文中的“hello_module.c”文件，改为以下内容：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//hello_module.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/module.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/kernel.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/init.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> debug = <span class=\"number\">1</span>;</span><br><span class=\"line\">module_param(debug, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\">MODULE_PARM_DESC(debug, <span class=\"string\">&quot;debugging information&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> dprintk(args...) <span class=\"keyword\">if</span>(debug)&#123;printk(KERN_DEBUG args);&#125;</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> myparm = <span class=\"number\">10</span>;</span><br><span class=\"line\">module_param(myparm, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\">MODULE_PARM_DESC(myparm, <span class=\"string\">&quot;kernel module parameter experiment.&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __init <span class=\"title function_\">parm_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>&#123;</span><br><span class=\"line\">   dprintk(<span class=\"string\">&quot;my linux kernel module init.\\n&quot;</span>);</span><br><span class=\"line\">   dprintk(<span class=\"string\">&quot;module parameter = %d\\n&quot;</span>, myparm);</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __exit <span class=\"title function_\">parm_exit</span><span class=\"params\">(<span class=\"type\">void</span>)</span>&#123;</span><br><span class=\"line\">   printk(<span class=\"string\">&quot;see you next time!\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">module_init(parm_init);</span><br><span class=\"line\">module_exit(parm_exit);</span><br><span class=\"line\"></span><br><span class=\"line\">MODULE_LICENSE(<span class=\"string\">&quot;GPL&quot;</span>);</span><br><span class=\"line\">MODULE_AUTHOR(<span class=\"string\">&quot;Mr Q&quot;</span>);</span><br><span class=\"line\">MODULE_DESCRIPTION(<span class=\"string\">&quot;kernel module paramter experiment&quot;</span>);</span><br><span class=\"line\">MODULE_ALIAS(<span class=\"string\">&quot;myparm&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<p>make编译，装载模块，并查看输出:</p>\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvV1p0QlZEQ1g3R25SZTlsLnBuZw\" alt=\"image-20200608122047862\"></p>\n<blockquote>\n<p>通过查看日志信息，可发现输出以上程序中 参数 的默认值。  </p>\n</blockquote>\n<p>卸载模块，赋值重新加载模块,修改参数 myparm 值为 116：  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insmod parm_module.ko myparm=116  </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/19043/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvZjdXNnF0ZGtVRDRPTDlvLnBuZw\" alt=\"image-20200608122350054\"></p>\n<blockquote>\n<p>通过查看日志信息，可发现 参数 值已经改变。  </p>\n</blockquote>\n","categories":[],"tags":[{"name":"linux","path":"api/tags/linux.json"},{"name":"kernel","path":"api/tags/kernel.json"},{"name":"c","path":"api/tags/c.json"}]}