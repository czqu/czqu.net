{"title":"CNAME记录指向vercel影响了CAA记录导致的SSL证书无法签发的问题","slug":"release/vercel导致的SSL证书无法签发的问题","date":"2021-09-30T15:16:00.000Z","updated":"2023-03-04T23:36:00.000Z","comments":true,"path":"api/articles/release/vercel导致的SSL证书无法签发的问题.json","excerpt":"直接看解决方案最狠的：直接把dns中有关vercel全暂停了或者：先暂停二级域名对vecel的解析，即暂停example.com-&gt;vecel然后再暂停受影响的子域的vecel 即暂停 a.example.com-&gt;vecel 问题今天阿里云告知我有一个域名的SSL证书快过期了，已经是老手的我熟练地打开阿里云控制台申请证书。 但是发生了一件怪事，以往证书都能在一分钟下发，而这一次等了好久都不行。我决定先睡一觉起来再看看。 睡醒以后，打开阿里云控制台，发现还是不成功，此时我仍然怀疑是阿里云的锅。于是我用freessl再申请了一次，等到下午还是没成功。用myssl.com/检测的结果如下： 地区 是否匹配 中国 不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com) 香港 不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com) 美国 不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digic","covers":null,"content":"<h3 id=\"直接看解决方案\"><a href=\"#直接看解决方案\" class=\"headerlink\" title=\"直接看解决方案\"></a>直接看解决方案</h3><p>最狠的：直接把dns中有关vercel全暂停了<br>或者：先暂停二级域名对vecel的解析，即暂停example.com-&gt;vecel<br>然后再暂停受影响的子域的vecel 即暂停 a.example.com-&gt;vecel </p>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>今天阿里云告知我有一个域名的SSL证书快过期了，已经是老手的我熟练地打开阿里云控制台申请证书。</p>\n<p>但是发生了一件怪事，以往证书都能在一分钟下发，而这一次等了好久都不行。我决定先睡一觉起来再看看。</p>\n<p>睡醒以后，打开阿里云控制台，发现还是不成功，此时我仍然怀疑是阿里云的锅。于是我用freessl再申请了一次，等到下午还是没成功。用<a href=\"https://myssl.com/\">myssl.com/</a>检测的结果如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">地区</th>\n<th align=\"left\">是否匹配</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">中国</td>\n<td align=\"left\">不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com)</td>\n</tr>\n<tr>\n<td align=\"left\">香港</td>\n<td align=\"left\">不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com)</td>\n</tr>\n<tr>\n<td align=\"left\">美国</td>\n<td align=\"left\">不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com)</td>\n</tr>\n</tbody></table>\n<p>我没设置过CAA记录啊！</p>\n<p>我心想应该不是DNS缓存的问题吧？不可能啊！</p>\n<p>但是我还是到阿里云控制台把所有的DNS记录都暂停解析。</p>\n<p>结果，居然成功了！成功了！</p>\n<p>后经过排查发现是解析到vercel上的cname记录导致的问题发生，这是为啥呢？vercel还有权限帮我设置CAA记录！？</p>\n<h3 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h3><p>后经一番搜索终于知道了原因，就是因为CAA记录惹的祸</p>\n<blockquote>\n<p> CAA(Certificate Authority Authorization)，即证书颁发机构授权。是一项新的可以添加到DNS记录中的额外字段,通过DNS机制创建CAA资源记录，可以限定域名颁发的证书和CA（证书颁发机构）之间的联系。未经授权的第三方尝试通过其他CA注册获取用于该域名的SSL/TLS证书将被拒绝。</p>\n<p>域名设置 CAA 记录，使网站所有者，可授权指定CA机构为自己的域名颁发证书，以防止HTTPS证书错误签发，从而提高网站安全性。</p>\n</blockquote>\n<p>补充一个知识点，CNAME记录会影响CAA记录：</p>\n<p>CAA 记录检查继续对指向不同域的 CNAME 记录进行。在此例中，<a href=\"www.example.com\">www.example.com</a> 指向 <a href=\"www.example.net\">www.example.net</a> ，后者也有 CAA 记录：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(Example 7 / www.example.com)</span><br><span class=\"line\">Domain   Record type  Flags  Tag      Value   </span><br><span class=\"line\">www.example.com.   CNAME www.example.net</span><br><span class=\"line\">www.example.net.   CAA           0      issue   \";\"</span><br><span class=\"line\"></span><br><span class=\"line\">(Result: CAA failed)</span><br></pre></td></tr></tbody></table></figure>\n\n<p>第一个记录将 CAA 检查转向 <a href=\"http://www.example.net.此/\">www.example.net。此</a> CAA 记录可阻止任何 CA 颁发证书，证书办法机构无法为 <a href=\"http://www.example.com/\">www.example.com</a> 颁发证书。</p>\n<p>如果所指向的域 (<a href=\"http://www.example.net/\">www.example.net</a>) 没有 CAA 记录，则 CAA 记录检查将上攀到基本域 (example.com)。</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(Example 8 / www.example.com)</span><br><span class=\"line\">Domain   Record type  Flags  Tag      Value   </span><br><span class=\"line\">www.example.com.   CNAME www.example.net</span><br><span class=\"line\">example.com.   CAA           0      issue   \"amazon.com\"</span><br><span class=\"line\"></span><br><span class=\"line\">(Result: CAA passed)</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>用白话说就是因为设置了cname指向vercel，而vercel设置了CAA记录，从而影响了我们的域名的CAA记录</strong>，用工具查询后发现确实如此：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">{</span><br><span class=\"line\">  \"canIssue\": false,</span><br><span class=\"line\">  \"status\": \"IssueMismatch\",</span><br><span class=\"line\">  \"domain\": \"czqu.net\",</span><br><span class=\"line\">  \"queryAt\": \"Sep 30, 2021 11:21:55 AM\",</span><br><span class=\"line\">  \"elapsed\": 1,</span><br><span class=\"line\">  \"caaRecordSet\": [</span><br><span class=\"line\">    {</span><br><span class=\"line\">      \"domain\": \"czqu.net\",</span><br><span class=\"line\">      \"caaRecords\": [</span><br><span class=\"line\">        {</span><br><span class=\"line\">          \"issuerCritical\": 0,</span><br><span class=\"line\">          \"tag\": \"issue\",</span><br><span class=\"line\">          \"value\": \"letsencrypt.org\",</span><br><span class=\"line\">          \"type\": 257,</span><br><span class=\"line\">          \"dclass\": 1,</span><br><span class=\"line\">          \"ttl\": 60</span><br><span class=\"line\">        },</span><br><span class=\"line\">        {</span><br><span class=\"line\">          \"issuerCritical\": 0,</span><br><span class=\"line\">          \"tag\": \"issue\",</span><br><span class=\"line\">          \"value\": \"globalsign.com\",</span><br><span class=\"line\">          \"type\": 257,</span><br><span class=\"line\">          \"dclass\": 1,</span><br><span class=\"line\">          \"ttl\": 60</span><br><span class=\"line\">        }</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    }</span><br><span class=\"line\">  ]</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>因此阿里云使用的免费DigiCert 证书颁发机构无法给我的域名颁发证书。</p>\n","more":"<h3 id=\"直接看解决方案\"><a href=\"#直接看解决方案\" class=\"headerlink\" title=\"直接看解决方案\"></a>直接看解决方案</h3><p>最狠的：直接把dns中有关vercel全暂停了<br>或者：先暂停二级域名对vecel的解析，即暂停example.com-&gt;vecel<br>然后再暂停受影响的子域的vecel 即暂停 a.example.com-&gt;vecel </p>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>今天阿里云告知我有一个域名的SSL证书快过期了，已经是老手的我熟练地打开阿里云控制台申请证书。</p>\n<p>但是发生了一件怪事，以往证书都能在一分钟下发，而这一次等了好久都不行。我决定先睡一觉起来再看看。</p>\n<p>睡醒以后，打开阿里云控制台，发现还是不成功，此时我仍然怀疑是阿里云的锅。于是我用freessl再申请了一次，等到下午还是没成功。用<a href=\"https://myssl.com/\">myssl.com/</a>检测的结果如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">地区</th>\n<th align=\"left\">是否匹配</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">中国</td>\n<td align=\"left\">不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com)</td>\n</tr>\n<tr>\n<td align=\"left\">香港</td>\n<td align=\"left\">不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com)</td>\n</tr>\n<tr>\n<td align=\"left\">美国</td>\n<td align=\"left\">不匹配 (验证失败，您的CAA配置不允许当前CA为您签发证书，请修改为：symantec.com或digicert.com)</td>\n</tr>\n</tbody></table>\n<p>我没设置过CAA记录啊！</p>\n<p>我心想应该不是DNS缓存的问题吧？不可能啊！</p>\n<p>但是我还是到阿里云控制台把所有的DNS记录都暂停解析。</p>\n<p>结果，居然成功了！成功了！</p>\n<p>后经过排查发现是解析到vercel上的cname记录导致的问题发生，这是为啥呢？vercel还有权限帮我设置CAA记录！？</p>\n<h3 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h3><p>后经一番搜索终于知道了原因，就是因为CAA记录惹的祸</p>\n<blockquote>\n<p> CAA(Certificate Authority Authorization)，即证书颁发机构授权。是一项新的可以添加到DNS记录中的额外字段,通过DNS机制创建CAA资源记录，可以限定域名颁发的证书和CA（证书颁发机构）之间的联系。未经授权的第三方尝试通过其他CA注册获取用于该域名的SSL/TLS证书将被拒绝。</p>\n<p>域名设置 CAA 记录，使网站所有者，可授权指定CA机构为自己的域名颁发证书，以防止HTTPS证书错误签发，从而提高网站安全性。</p>\n</blockquote>\n<p>补充一个知识点，CNAME记录会影响CAA记录：</p>\n<p>CAA 记录检查继续对指向不同域的 CNAME 记录进行。在此例中，<a href=\"www.example.com\">www.example.com</a> 指向 <a href=\"www.example.net\">www.example.net</a> ，后者也有 CAA 记录：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(Example 7 / www.example.com)</span><br><span class=\"line\">Domain   Record type  Flags  Tag      Value   </span><br><span class=\"line\">www.example.com.   CNAME www.example.net</span><br><span class=\"line\">www.example.net.   CAA           0      issue   &quot;;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">(Result: CAA failed)</span><br></pre></td></tr></table></figure>\n\n<p>第一个记录将 CAA 检查转向 <a href=\"http://www.example.net.此/\">www.example.net。此</a> CAA 记录可阻止任何 CA 颁发证书，证书办法机构无法为 <a href=\"http://www.example.com/\">www.example.com</a> 颁发证书。</p>\n<p>如果所指向的域 (<a href=\"http://www.example.net/\">www.example.net</a>) 没有 CAA 记录，则 CAA 记录检查将上攀到基本域 (example.com)。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(Example 8 / www.example.com)</span><br><span class=\"line\">Domain   Record type  Flags  Tag      Value   </span><br><span class=\"line\">www.example.com.   CNAME www.example.net</span><br><span class=\"line\">example.com.   CAA           0      issue   &quot;amazon.com&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">(Result: CAA passed)</span><br></pre></td></tr></table></figure>\n\n<p><strong>用白话说就是因为设置了cname指向vercel，而vercel设置了CAA记录，从而影响了我们的域名的CAA记录</strong>，用工具查询后发现确实如此：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;canIssue&quot;: false,</span><br><span class=\"line\">  &quot;status&quot;: &quot;IssueMismatch&quot;,</span><br><span class=\"line\">  &quot;domain&quot;: &quot;czqu.net&quot;,</span><br><span class=\"line\">  &quot;queryAt&quot;: &quot;Sep 30, 2021 11:21:55 AM&quot;,</span><br><span class=\"line\">  &quot;elapsed&quot;: 1,</span><br><span class=\"line\">  &quot;caaRecordSet&quot;: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;domain&quot;: &quot;czqu.net&quot;,</span><br><span class=\"line\">      &quot;caaRecords&quot;: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;issuerCritical&quot;: 0,</span><br><span class=\"line\">          &quot;tag&quot;: &quot;issue&quot;,</span><br><span class=\"line\">          &quot;value&quot;: &quot;letsencrypt.org&quot;,</span><br><span class=\"line\">          &quot;type&quot;: 257,</span><br><span class=\"line\">          &quot;dclass&quot;: 1,</span><br><span class=\"line\">          &quot;ttl&quot;: 60</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          &quot;issuerCritical&quot;: 0,</span><br><span class=\"line\">          &quot;tag&quot;: &quot;issue&quot;,</span><br><span class=\"line\">          &quot;value&quot;: &quot;globalsign.com&quot;,</span><br><span class=\"line\">          &quot;type&quot;: 257,</span><br><span class=\"line\">          &quot;dclass&quot;: 1,</span><br><span class=\"line\">          &quot;ttl&quot;: 60</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>因此阿里云使用的免费DigiCert 证书颁发机构无法给我的域名颁发证书。</p>\n","categories":[],"tags":[{"name":"后端","path":"api/tags/后端.json"},{"name":"踩坑","path":"api/tags/踩坑.json"}]}