{"title":"Linux内核的编译","slug":"release/2020-3-3-Compilation-of-the-Linux-kernel","date":"2020-03-03T02:00:00.000Z","updated":"2020-03-03T02:00:00.000Z","comments":true,"path":"api/articles/release/2020-3-3-Compilation-of-the-Linux-kernel.json","excerpt":"前言： 常见 Linux 内核编译有两种方式，一是直接在 Linux 系统上编译得到二进制文件，并对原有 Linux 内核进行替换，即更换 Linux 内核，此方法可能因新内核有 bug 导致系统奔溃，且难以返回原版本内核而不得不重装；第二种方法则是在模拟器中运行新的 Linux 内核，以避免对系统内核的修改。 BusyBox 是一个集成了三百多个最常用 Linux 命令和工具的软件，因为单独的 Linux 内核无任何用于用户交互的 UI，所以需要通过其它工具与新编译的Linux 内核交互。 QEMU 是以 GPL 许可证分发源码的模拟处理器，可用于模拟常见的硬件平台，常用于在 Linux 系统中建立虚拟机。 本文在阿里云 Ubuntu 18.04 64 位操作系统环境下编译 ARM Linux 内核。过程中主要是用交叉编译工具链 gcc-arm-linux-gnueabi 编译系统源码，并使用 QEMU 软件仿真硬件平台测试对象系统。 **建议使用 root 用户操作 ** 本文所使用的环境： 操作系统：4.15.0-96-generic #97-Ubuntu SMP Wed Apr","covers":["/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvbnZ6d0ViUDZjMzVObDh0LnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvb0wydXdBSGtNOHJmSVVSLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvVGhwZW9meEh6REttQnZuLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvRWM3MWZ6bjU4aEJRVlkyLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvVlR2RFJzNjlKN0lGdVFOLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvYnZTb1R0T0VuZ1BobTdKLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvOFNVTlBqbFl6aWhWREJBLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvS3ZOcGJaaUNUT1dxSHRhLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNzV6aU04YUxyU0QyZXV2LnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvdWJsUmNaVDlxVmZFRjROLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvYXN3NkpOT3hISUVvbWJqLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvT0FGN3UyRWhLQ1dVWTZWLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgveGRBTERNSUd5c2lyTmE2LnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvcllBbTQ1blJNOUtVdXBaLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvd3NTNkJ1eVV6ckdaZVEyLnBuZw.png","/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNVZ0cHkyUkRrSlNUWmRoLnBuZw.png"],"content":"<blockquote>\n<p>前言：</p>\n<p>常见 Linux 内核编译有两种方式，一是直接在 Linux 系统上编译得到二进制文件，并对原有 Linux 内核进行替换，即更换 Linux 内核，此方法可能因新内核有 bug 导致系统奔溃，且难以返回原版本内核而不得不重装；第二种方法则是在模拟器中运行新的 Linux 内核，以避免对系统内核的修改。</p>\n<p>BusyBox 是一个集成了三百多个最常用 Linux 命令和工具的软件，因为单独的 Linux 内核无任何用于用户交互的 UI，所以需要通过其它工具与新编译的Linux 内核交互。</p>\n<p>QEMU 是以 GPL 许可证分发源码的模拟处理器，可用于模拟常见的硬件平台，常用于在 Linux 系统中建立虚拟机。</p>\n<p>本文在阿里云 Ubuntu 18.04 64 位操作系统环境下编译 ARM Linux 内核。过程中主要是用交叉编译工具链 gcc-arm-linux-gnueabi 编译系统源码，并使用 QEMU 软件仿真硬件平台测试对象系统。</p>\n<p>**建议使用 root 用户操作  **</p>\n</blockquote>\n<p><strong>本文所使用的环境：</strong></p>\n<blockquote>\n<p>操作系统：4.15.0-96-generic #97-Ubuntu SMP Wed Apr 1 03:25:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</p>\n<p>gcc: 7.5.0</p>\n<p>qemu: 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.26)</p>\n<p>make:GNU Make 4.1</p>\n</blockquote>\n<ol>\n<li><h5 id=\"工具准备\"><a href=\"#工具准备\" class=\"headerlink\" title=\"工具准备\"></a>工具准备</h5><p>Busybox 需手动下载安装，QEMU 等其他工具可在线安装。  </p>\n<p>Linux内核下载：<a href=\"https://www.kernel.org/\">https://www.kernel.org/</a></p>\n<p>本文使用5.4.45版本的,并使用清华大学镜像</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.4.5.tar.gz</span><br></pre></td></tr></tbody></table></figure>\n\n<p>Busybox ：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://busybox.net/downloads/busybox-1.28.4.tar.bz2</span><br></pre></td></tr></tbody></table></figure></li>\n<li><p>环境配置</p>\n<p>Linux 内核编译环境需要大量软件包，可提前直接在线安装，或在内核编译的过程中安装，若缺少安装包，内核编译过程中会提示缺失错误。以下是部分需要的软件包，其中部分相同功能的软件包在不同的 Linux 版本下会以不同的名字存在。  </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install gcc qemu qemu-system-arm gcc-arm-linux-gnueabi libncurses5-dev build-essential flex bison bc  </span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvbnZ6d0ViUDZjMzVObDh0LnBuZw.png\" alt=\"image-20200607225302378\"></p>\n</li>\n<li><h5 id=\"编译内核\"><a href=\"#编译内核\" class=\"headerlink\" title=\"编译内核\"></a>编译内核</h5><p><strong>解压 Linux 内核文件包：</strong> </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -xzvf linux-5.4.5.tar.gz</span><br></pre></td></tr></tbody></table></figure>\n\n<p><strong>编译最小文件系统：</strong>  </p>\n<p>解压 busybox,进入目录并编译:  </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -jxvf busybox-1.28.4.tar.bz2</span><br><span class=\"line\"><span class=\"built_in\">cd</span> busybox-1.28.4</span><br><span class=\"line\"><span class=\"built_in\">export</span> ARCH=arm</span><br><span class=\"line\"><span class=\"built_in\">export</span> CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class=\"line\">make menuconfig</span><br></pre></td></tr></tbody></table></figure>\n\n<p>以上内容中，“export”后是指定交叉编译工具链，指定芯片框架为 ARM。如下图所示是图形化界面进行内核配置。  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvb0wydXdBSGtNOHJmSVVSLnBuZw.png\" alt=\"image-20200607231737776\"></p>\n<blockquote>\n<p>按照以下路径配置成静态编译（回车进入，空格选中） ：</p>\n<p>Settings —-&gt;</p>\n<p>　　Build Options<br>　　　　　　　[*]Build static binary(no shared libs)  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvVGhwZW9meEh6REttQnZuLnBuZw.png\" alt=\"image-20200607232057964\"></p>\n</blockquote>\n<p>配置完毕退出后继续完成编译：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make install  </span><br></pre></td></tr></tbody></table></figure>\n\n<p>完成后会在目录中生成“_install”目录，本目录存放了编译好的文件系统需要的命令集合，如下图所示：</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvRWM3MWZ6bjU4aEJRVlkyLnBuZw.png\" alt=\"image-20200607233324632\">  </p>\n<p>将上一步骤中生成的“_install”目录拷贝至之前解压后的内核目录，进入“_install”目录，分别创建 etc、dev、mnt、etc/init.d 等目录。  </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cp</span> -r ./busybox-1.28.4/_install ./linux-5.4.5/_install</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ./linux-5.4.5/_install/</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> etc</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> dev</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> mnt</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p etc/init.d</span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvVlR2RFJzNjlKN0lGdVFOLnBuZw.png\" alt=\"image-20200607234014872\"></p>\n<p>在“_install/etc/init.d”目录下新建“rcS”文件，并写入以下内容：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /proc</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /tmp</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /sys</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /mnt</span><br><span class=\"line\">/bin/mount -a</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /dev/pts</span><br><span class=\"line\">mount -t devpts devpts /dev/pts</span><br><span class=\"line\"><span class=\"built_in\">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class=\"line\">mdev –s  </span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvYnZTb1R0T0VuZ1BobTdKLnBuZw.png\" alt=\"image-20200607234356567\"></p>\n<p>在“_install/etc”目录创建“fstab”文件，并写入以下内容：  </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">proc /proc proc defaults 0 0</span><br><span class=\"line\">tmpfs /tmp tmpfs defaults 0 0</span><br><span class=\"line\">sysfs /sys sysfs defaults 0 0</span><br><span class=\"line\">tempfs /dev tmpfs defaults 0 0</span><br><span class=\"line\">debugfs /sys/kernel/debug debugfs defaults 0 0  </span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvOFNVTlBqbFl6aWhWREJBLnBuZw.png\" alt=\"image-20200607234653102\"></p>\n<p>在“_install/etc”目录创建“inittab”文件，并写入以下内容：  </p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">::sysinit:/etc/init.d/rcS</span><br><span class=\"line\">::respawn:-/bin/sh</span><br><span class=\"line\">::askfirst:-/bin/sh</span><br><span class=\"line\">::ctrlaltdel:/bin/umount -a -r  </span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvS3ZOcGJaaUNUT1dxSHRhLnBuZw.png\" alt=\"image-20200607234926195\"></p>\n<p>在“_install/dev”目录中创建如下设备节点。 ：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mknod</span> console c 5 1</span><br><span class=\"line\"><span class=\"built_in\">mknod</span> null c 1 3  </span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNzV6aU04YUxyU0QyZXV2LnBuZw.png\" alt=\"image-20200607235200236\"></p>\n<p>完成上述设置后，在内核目录中编译内核 ：</p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> ARCH=arm</span><br><span class=\"line\"><span class=\"built_in\">export</span> CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class=\"line\">make vexpress_defconfig</span><br><span class=\"line\">make menuconfig  </span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvdWJsUmNaVDlxVmZFRjROLnBuZw.png\" alt=\"image-20200607235445654\"></p>\n<blockquote>\n<p>make menuconfig 设置中，按照以下路径，在 initramfs source file 中填入“_install”(按回车填入) :<br>General setup —-&gt;<br>　　　　　　 [*]Initial RAM filesystem and RAM disk (initramfs/initrd) support<br>　　　　　　　　　　　(_install)Initramfs source file(s)  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvYXN3NkpOT3hISUVvbWJqLnBuZw.png\" alt=\"image-20200607235912353\"></p>\n<p>返回上一层，在</p>\n<p>Boot option  —-&gt;<br>　　　　()Default kernel command string  </p>\n<p>回车进入 Default kernel command string 并清 空 。 下 图 中 删 除 原 有 内 容 用<br>Ctl+Backspace 键。  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvT0FGN3UyRWhLQ1dVWTZWLnBuZw.png\" alt=\"image-20200608000442154\"></p>\n<p>配置 memory split 为“3G/1G user/kernel split”,并打开High Memory Support：</p>\n<p>Kernel features —-&gt;<br>　　　　Memory split(3G/1G user/kernel split) -<br>　　　　[*] High Memory Support  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgveGRBTERNSUd5c2lyTmE2LnBuZw.png\" alt=\"image-20200608000716572\"></p>\n</blockquote>\n<p>在内核目录下编译内核(此步骤时间较长)  </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make bzImage ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class=\"line\">make dtbs </span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>可能会出现“./usr/gen_initramfs_list.sh: 131: local: 1: bad variable name”的错误，原因是以前用的bash执行而现在使用sh。</p>\n<p>解决办法：131行改为 ：</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local dev=\"`LC_ALL=C ls -l \"${location}\"`\"</span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvcllBbTQ1blJNOUtVdXBaLnBuZw.png\" alt=\"image-20200608093024179\"></p>\n</blockquote>\n<p>编译完成后会有如下提示，并显示编译后内核的存储路径。 </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvd3NTNkJ1eVV6ckdaZVEyLnBuZw.png\" alt=\"image-20200608003409578\"></p>\n</li>\n<li><h5 id=\"运行-QEMU\"><a href=\"#运行-QEMU\" class=\"headerlink\" title=\"运行 QEMU\"></a>运行 QEMU</h5><p>如下所示，输入 QEMU 启动命令，成功启动 QEMU，注意需指定 bzImage路径，并注意使用当前命令与 bzImage 路径的关系。  </p>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-arm -M vexpress-a9 -m 256M -kernel <span class=\"built_in\">arch</span>/arm/boot/zImage -append <span class=\"string\">\"rdinit=/linuxrc console=ttyAMA0 loglevel=8\"</span> -dtb <span class=\"built_in\">arch</span>/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic  </span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>以上命令中参数含义如下；<br>-M：指定硬件芯片框架<br>-m：指定运行内存大小<br>-kernel：指定运行的内核镜像<br>-dtb：指定具体芯片的配置信息<br>-nographic：指定不使用图形界面  </p>\n</blockquote>\n</li>\n<li><h5 id=\"完成\"><a href=\"#完成\" class=\"headerlink\" title=\"完成\"></a>完成</h5><p>如下图可以看到，成功运行了我们刚刚编译的新内核</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNVZ0cHkyUkRrSlNUWmRoLnBuZw.png\" alt=\"image-20200608004409477\"></p>\n</li>\n</ol>\n","more":"<blockquote>\n<p>前言：</p>\n<p>常见 Linux 内核编译有两种方式，一是直接在 Linux 系统上编译得到二进制文件，并对原有 Linux 内核进行替换，即更换 Linux 内核，此方法可能因新内核有 bug 导致系统奔溃，且难以返回原版本内核而不得不重装；第二种方法则是在模拟器中运行新的 Linux 内核，以避免对系统内核的修改。</p>\n<p>BusyBox 是一个集成了三百多个最常用 Linux 命令和工具的软件，因为单独的 Linux 内核无任何用于用户交互的 UI，所以需要通过其它工具与新编译的Linux 内核交互。</p>\n<p>QEMU 是以 GPL 许可证分发源码的模拟处理器，可用于模拟常见的硬件平台，常用于在 Linux 系统中建立虚拟机。</p>\n<p>本文在阿里云 Ubuntu 18.04 64 位操作系统环境下编译 ARM Linux 内核。过程中主要是用交叉编译工具链 gcc-arm-linux-gnueabi 编译系统源码，并使用 QEMU 软件仿真硬件平台测试对象系统。</p>\n<p>**建议使用 root 用户操作  **</p>\n</blockquote>\n<p><strong>本文所使用的环境：</strong></p>\n<blockquote>\n<p>操作系统：4.15.0-96-generic #97-Ubuntu SMP Wed Apr 1 03:25:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</p>\n<p>gcc: 7.5.0</p>\n<p>qemu: 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.26)</p>\n<p>make:GNU Make 4.1</p>\n</blockquote>\n<ol>\n<li><h5 id=\"工具准备\"><a href=\"#工具准备\" class=\"headerlink\" title=\"工具准备\"></a>工具准备</h5><p>Busybox 需手动下载安装，QEMU 等其他工具可在线安装。  </p>\n<p>Linux内核下载：<a href=\"https://www.kernel.org/\">https://www.kernel.org/</a></p>\n<p>本文使用5.4.45版本的,并使用清华大学镜像</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.4.5.tar.gz</span><br></pre></td></tr></table></figure>\n\n<p>Busybox ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://busybox.net/downloads/busybox-1.28.4.tar.bz2</span><br></pre></td></tr></table></figure></li>\n<li><p>环境配置</p>\n<p>Linux 内核编译环境需要大量软件包，可提前直接在线安装，或在内核编译的过程中安装，若缺少安装包，内核编译过程中会提示缺失错误。以下是部分需要的软件包，其中部分相同功能的软件包在不同的 Linux 版本下会以不同的名字存在。  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install gcc qemu qemu-system-arm gcc-arm-linux-gnueabi libncurses5-dev build-essential flex bison bc  </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvbnZ6d0ViUDZjMzVObDh0LnBuZw.png\" alt=\"image-20200607225302378\"></p>\n</li>\n<li><h5 id=\"编译内核\"><a href=\"#编译内核\" class=\"headerlink\" title=\"编译内核\"></a>编译内核</h5><p><strong>解压 Linux 内核文件包：</strong> </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -xzvf linux-5.4.5.tar.gz</span><br></pre></td></tr></table></figure>\n\n<p><strong>编译最小文件系统：</strong>  </p>\n<p>解压 busybox,进入目录并编译:  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -jxvf busybox-1.28.4.tar.bz2</span><br><span class=\"line\"><span class=\"built_in\">cd</span> busybox-1.28.4</span><br><span class=\"line\"><span class=\"built_in\">export</span> ARCH=arm</span><br><span class=\"line\"><span class=\"built_in\">export</span> CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class=\"line\">make menuconfig</span><br></pre></td></tr></table></figure>\n\n<p>以上内容中，“export”后是指定交叉编译工具链，指定芯片框架为 ARM。如下图所示是图形化界面进行内核配置。  </p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvb0wydXdBSGtNOHJmSVVSLnBuZw.png\" alt=\"image-20200607231737776\"></p>\n<blockquote>\n<p>按照以下路径配置成静态编译（回车进入，空格选中） ：</p>\n<p>Settings —-&gt;</p>\n<p>　　Build Options<br>　　　　　　　[*]Build static binary(no shared libs)  </p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvVGhwZW9meEh6REttQnZuLnBuZw.png\" alt=\"image-20200607232057964\"></p>\n</blockquote>\n<p>配置完毕退出后继续完成编译：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make install  </span><br></pre></td></tr></table></figure>\n\n<p>完成后会在目录中生成“_install”目录，本目录存放了编译好的文件系统需要的命令集合，如下图所示：</p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvRWM3MWZ6bjU4aEJRVlkyLnBuZw.png\" alt=\"image-20200607233324632\">  </p>\n<p>将上一步骤中生成的“_install”目录拷贝至之前解压后的内核目录，进入“_install”目录，分别创建 etc、dev、mnt、etc/init.d 等目录。  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cp</span> -r ./busybox-1.28.4/_install ./linux-5.4.5/_install</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ./linux-5.4.5/_install/</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> etc</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> dev</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> mnt</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p etc/init.d</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvVlR2RFJzNjlKN0lGdVFOLnBuZw.png\" alt=\"image-20200607234014872\"></p>\n<p>在“_install/etc/init.d”目录下新建“rcS”文件，并写入以下内容：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /proc</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /tmp</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /sys</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /mnt</span><br><span class=\"line\">/bin/mount -a</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /dev/pts</span><br><span class=\"line\">mount -t devpts devpts /dev/pts</span><br><span class=\"line\"><span class=\"built_in\">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class=\"line\">mdev –s  </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvYnZTb1R0T0VuZ1BobTdKLnBuZw.png\" alt=\"image-20200607234356567\"></p>\n<p>在“_install/etc”目录创建“fstab”文件，并写入以下内容：  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">proc /proc proc defaults 0 0</span><br><span class=\"line\">tmpfs /tmp tmpfs defaults 0 0</span><br><span class=\"line\">sysfs /sys sysfs defaults 0 0</span><br><span class=\"line\">tempfs /dev tmpfs defaults 0 0</span><br><span class=\"line\">debugfs /sys/kernel/debug debugfs defaults 0 0  </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvOFNVTlBqbFl6aWhWREJBLnBuZw.png\" alt=\"image-20200607234653102\"></p>\n<p>在“_install/etc”目录创建“inittab”文件，并写入以下内容：  </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">::sysinit:/etc/init.d/rcS</span><br><span class=\"line\">::respawn:-/bin/sh</span><br><span class=\"line\">::askfirst:-/bin/sh</span><br><span class=\"line\">::ctrlaltdel:/bin/umount -a -r  </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvS3ZOcGJaaUNUT1dxSHRhLnBuZw.png\" alt=\"image-20200607234926195\"></p>\n<p>在“_install/dev”目录中创建如下设备节点。 ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mknod</span> console c 5 1</span><br><span class=\"line\"><span class=\"built_in\">mknod</span> null c 1 3  </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNzV6aU04YUxyU0QyZXV2LnBuZw.png\" alt=\"image-20200607235200236\"></p>\n<p>完成上述设置后，在内核目录中编译内核 ：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> ARCH=arm</span><br><span class=\"line\"><span class=\"built_in\">export</span> CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class=\"line\">make vexpress_defconfig</span><br><span class=\"line\">make menuconfig  </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvdWJsUmNaVDlxVmZFRjROLnBuZw.png\" alt=\"image-20200607235445654\"></p>\n<blockquote>\n<p>make menuconfig 设置中，按照以下路径，在 initramfs source file 中填入“_install”(按回车填入) :<br>General setup —-&gt;<br>　　　　　　 [*]Initial RAM filesystem and RAM disk (initramfs/initrd) support<br>　　　　　　　　　　　(_install)Initramfs source file(s)  </p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvYXN3NkpOT3hISUVvbWJqLnBuZw.png\" alt=\"image-20200607235912353\"></p>\n<p>返回上一层，在</p>\n<p>Boot option  —-&gt;<br>　　　　()Default kernel command string  </p>\n<p>回车进入 Default kernel command string 并清 空 。 下 图 中 删 除 原 有 内 容 用<br>Ctl+Backspace 键。  </p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvT0FGN3UyRWhLQ1dVWTZWLnBuZw.png\" alt=\"image-20200608000442154\"></p>\n<p>配置 memory split 为“3G/1G user/kernel split”,并打开High Memory Support：</p>\n<p>Kernel features —-&gt;<br>　　　　Memory split(3G/1G user/kernel split) -<br>　　　　[*] High Memory Support  </p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgveGRBTERNSUd5c2lyTmE2LnBuZw.png\" alt=\"image-20200608000716572\"></p>\n</blockquote>\n<p>在内核目录下编译内核(此步骤时间较长)  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make bzImage ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class=\"line\">make dtbs </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可能会出现“./usr/gen_initramfs_list.sh: 131: local: 1: bad variable name”的错误，原因是以前用的bash执行而现在使用sh。</p>\n<p>解决办法：131行改为 ：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local dev=&quot;`LC_ALL=C ls -l &quot;$&#123;location&#125;&quot;`&quot;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvcllBbTQ1blJNOUtVdXBaLnBuZw.png\" alt=\"image-20200608093024179\"></p>\n</blockquote>\n<p>编译完成后会有如下提示，并显示编译后内核的存储路径。 </p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvd3NTNkJ1eVV6ckdaZVEyLnBuZw.png\" alt=\"image-20200608003409578\"></p>\n</li>\n<li><h5 id=\"运行-QEMU\"><a href=\"#运行-QEMU\" class=\"headerlink\" title=\"运行 QEMU\"></a>运行 QEMU</h5><p>如下所示，输入 QEMU 启动命令，成功启动 QEMU，注意需指定 bzImage路径，并注意使用当前命令与 bzImage 路径的关系。  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-arm -M vexpress-a9 -m 256M -kernel <span class=\"built_in\">arch</span>/arm/boot/zImage -append <span class=\"string\">&quot;rdinit=/linuxrc console=ttyAMA0 loglevel=8&quot;</span> -dtb <span class=\"built_in\">arch</span>/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic  </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以上命令中参数含义如下；<br>-M：指定硬件芯片框架<br>-m：指定运行内存大小<br>-kernel：指定运行的内核镜像<br>-dtb：指定具体芯片的配置信息<br>-nographic：指定不使用图形界面  </p>\n</blockquote>\n</li>\n<li><h5 id=\"完成\"><a href=\"#完成\" class=\"headerlink\" title=\"完成\"></a>完成</h5><p>如下图可以看到，成功运行了我们刚刚编译的新内核</p>\n<p><img src=\"/cn/posts/2461/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjAvMDYvMDgvNVZ0cHkyUkRrSlNUWmRoLnBuZw.png\" alt=\"image-20200608004409477\"></p>\n</li>\n</ol>\n","categories":[],"tags":[{"name":"Linux","path":"api/tags/Linux.json"},{"name":"操作系统","path":"api/tags/操作系统.json"},{"name":"cpp","path":"api/tags/cpp.json"}]}