{"title":"给你的Powershell做一个“sudo”","slug":"draft/sudo-in-powershell","date":"2020-11-14T09:23:48.000Z","updated":"2020-11-14T09:23:48.000Z","comments":true,"path":"api/articles/draft/sudo-in-powershell.json","excerpt":"前言 sudo是linux系统管理指令，是允许系统管理员让普通用户执行一些或者全部的root命令的一个工具，如halt，reboot，su等等。这样不仅减少了root用户的登录 和管理时间，同样也提高了安全性。sudo不是对shell的一个代替，它是面向每个命令的。 开始行动在Windows系统上sudo对应的就是管理员权限了。 一般使用Powershell时，并不会管理员启动，当执行需要权限的命令（比如net start mysql），就需要以管理员打开新的窗口。 为了一步到位，这里给powershell创建一个alias -&gt; sudo 来运行需要管理员权限的命令。 在文档目录中(在powershell执行$profile即可输出此文件路径)，新建文件夹WindowsPowerShell，新建文件Microsoft.PowerShell_profile.ps1。 此文件是在启动Powershell时执行的脚本。set-alias 在退出后就会失效，所以放到启动脚本中。 追加如下代码,然后重启Powershell窗口。 12345function _sudo { $ss = \"","covers":["/cn/posts/58638/image-20201114173152782.png","/cn/posts/58638/20191015105843814.png","/cn/posts/58638/image-20201114173232592.png","/cn/posts/58638/image-20201114173854864.png","/cn/posts/58638/image-20201114173917127.png","/cn/posts/58638/image-20201114174133879.png"],"content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><blockquote>\n<p>sudo是linux系统管理指令，是允许系统管理员让普通用户执行一些或者全部的root命令的一个工具，如halt，reboot，su等等。这样不仅减少了root用户的登录 和管理时间，同样也提高了安全性。sudo不是对shell的一个代替，它是面向每个命令的。</p>\n</blockquote>\n<h2 id=\"开始行动\"><a href=\"#开始行动\" class=\"headerlink\" title=\"开始行动\"></a>开始行动</h2><p>在Windows系统上sudo对应的就是管理员权限了。</p>\n<p>一般使用Powershell时，并不会管理员启动，当执行需要权限的命令（比如net start mysql），就需要以管理员打开新的窗口。</p>\n<p>为了一步到位，这里给powershell创建一个<code>alias</code> -&gt; <code>sudo</code> 来运行需要管理员权限的命令。</p>\n<p>在文档目录中(在<code>powershell</code>执行<code>$profile</code>即可输出此文件路径)，新建文件夹<code>WindowsPowerShell</code>，新建文件<code>Microsoft.PowerShell_profile.ps1</code>。</p>\n<blockquote>\n<p>此文件是在启动Powershell时执行的脚本。set-alias 在退出后就会失效，所以放到启动脚本中。</p>\n</blockquote>\n<p>追加如下代码,<strong>然后重启Powershell窗口。</strong></p>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_sudo</span></span> {</span><br><span class=\"line\">    <span class=\"variable\">$ss</span> = <span class=\"string\">\"<span class=\"variable\">$args</span> ; pause\"</span></span><br><span class=\"line\">    <span class=\"built_in\">Start-Process</span> powershell <span class=\"literal\">-Verb</span> runAs <span class=\"literal\">-ArgumentList</span> <span class=\"variable\">$ss</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"built_in\">set-alias</span>  <span class=\"literal\">-name</span> sudo <span class=\"literal\">-value</span> _sudo</span><br></pre></td></tr></tbody></table></figure>\n\n<p>保存后发现无法加载，因为默认不加载外部脚本，管理员权限下 powershell 运行：</p>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">set-ExecutionPolicy</span> RemoteSigned</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p> <strong>REMOTESIGNED</strong> 脚本可以运行。这是 Windows Server 2012 R2 中的默认执行策略。 要求从 Internet 下载的脚本和配置文件（包括电子邮件和即时消息程序）具有受信任的发布者的数字签名。 不要求你在本地计算机上编写的脚本（不是从 Internet 下载的）具有数字签名。 如果脚本已被取消阻止（比如通过使用 Unblock-File cmdlet），则运行从 Internet 下载但未签名的脚本。 存在运行来自 Internet 之外的源的未签名脚本和已签名但却是恶意的脚本的风险。</p>\n</blockquote>\n<p>完成设置后，输入sudo会打开新的窗口执行命令:</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/58638/image-20201114173152782.png\" alt=\"image-20201114173152782\"></p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/58638/20191015105843814.png\" alt=\"在这里插入图片描述\"></p>\n<p>有时候我们又希望直接输入命令打开新窗口,继续追加如下代码，重启powershell</p>\n<figure class=\"highlight powershell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">Function</span> <span class=\"title\">_su</span></span> {<span class=\"built_in\">Start-Process</span> <span class=\"literal\">-verb</span> runas <span class=\"string\">\"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\Powershell.exe\"</span>}</span><br><span class=\"line\"><span class=\"built_in\">Set-Alias</span> su _su</span><br></pre></td></tr></tbody></table></figure>\n\n<p>输入su命令后会直接弹出一个新的具有管理员权限的powershell</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/58638/image-20201114173232592.png\"></p>\n<h2 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h2><h3 id=\"cmd-提权：\"><a href=\"#cmd-提权：\" class=\"headerlink\" title=\"cmd 提权：\"></a>cmd 提权：</h3><figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">runas /user:hackett_yu@outlook.com cmd</span><br><span class=\"line\">doskey sudo=runas /user:{$username} cmd</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"快速进入命令行的方法\"><a href=\"#快速进入命令行的方法\" class=\"headerlink\" title=\"快速进入命令行的方法\"></a>快速进入命令行的方法</h3><p>如何从你的文件夹里快速打开命令行？请看下面</p>\n<p>1.将鼠标置于指定文件的空白处，按住Shift键的同时右击鼠标，这时在出来的右键菜单里会出现一个”打开命令行”  的菜—单选项，也有可能是“在此处打开Powershell窗口(s)”。这个具体和电脑个体设置有关。</p>\n<p>2.直接在指定目录的地址栏中输入<code>cmd</code>,即可进入命令行模式，同理输入powershell也可以</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/58638/image-20201114173854864.png\" alt=\"image-20201114173854864\"></p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/58638/image-20201114173917127.png\" alt=\"image-20201114173917127\"></p>\n<p>3.安装Windows Terminal ，在应用商店即可下载。（在地址栏输入wt也可以快速调出，但是不会定位到当前目录）</p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/58638/image-20201114174133879.png\" alt=\"image-20201114174133879\"></p>\n","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><blockquote>\n<p>sudo是linux系统管理指令，是允许系统管理员让普通用户执行一些或者全部的root命令的一个工具，如halt，reboot，su等等。这样不仅减少了root用户的登录 和管理时间，同样也提高了安全性。sudo不是对shell的一个代替，它是面向每个命令的。</p>\n</blockquote>\n<h2 id=\"开始行动\"><a href=\"#开始行动\" class=\"headerlink\" title=\"开始行动\"></a>开始行动</h2><p>在Windows系统上sudo对应的就是管理员权限了。</p>\n<p>一般使用Powershell时，并不会管理员启动，当执行需要权限的命令（比如net start mysql），就需要以管理员打开新的窗口。</p>\n<p>为了一步到位，这里给powershell创建一个<code>alias</code> -&gt; <code>sudo</code> 来运行需要管理员权限的命令。</p>\n<p>在文档目录中(在<code>powershell</code>执行<code>$profile</code>即可输出此文件路径)，新建文件夹<code>WindowsPowerShell</code>，新建文件<code>Microsoft.PowerShell_profile.ps1</code>。</p>\n<blockquote>\n<p>此文件是在启动Powershell时执行的脚本。set-alias 在退出后就会失效，所以放到启动脚本中。</p>\n</blockquote>\n<p>追加如下代码,<strong>然后重启Powershell窗口。</strong></p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_sudo</span></span> &#123;</span><br><span class=\"line\">    <span class=\"variable\">$ss</span> = <span class=\"string\">&quot;<span class=\"variable\">$args</span> ; pause&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">Start-Process</span> powershell <span class=\"literal\">-Verb</span> runAs <span class=\"literal\">-ArgumentList</span> <span class=\"variable\">$ss</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">set-alias</span>  <span class=\"literal\">-name</span> sudo <span class=\"literal\">-value</span> _sudo</span><br></pre></td></tr></table></figure>\n\n<p>保存后发现无法加载，因为默认不加载外部脚本，管理员权限下 powershell 运行：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">set-ExecutionPolicy</span> RemoteSigned</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p> <strong>REMOTESIGNED</strong> 脚本可以运行。这是 Windows Server 2012 R2 中的默认执行策略。 要求从 Internet 下载的脚本和配置文件（包括电子邮件和即时消息程序）具有受信任的发布者的数字签名。 不要求你在本地计算机上编写的脚本（不是从 Internet 下载的）具有数字签名。 如果脚本已被取消阻止（比如通过使用 Unblock-File cmdlet），则运行从 Internet 下载但未签名的脚本。 存在运行来自 Internet 之外的源的未签名脚本和已签名但却是恶意的脚本的风险。</p>\n</blockquote>\n<p>完成设置后，输入sudo会打开新的窗口执行命令:</p>\n<p><img src=\"/cn/posts/58638/image-20201114173152782.png\" alt=\"image-20201114173152782\"></p>\n<p><img src=\"/cn/posts/58638/20191015105843814.png\" alt=\"在这里插入图片描述\"></p>\n<p>有时候我们又希望直接输入命令打开新窗口,继续追加如下代码，重启powershell</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">Function</span> <span class=\"title\">_su</span></span> &#123;<span class=\"built_in\">Start-Process</span> <span class=\"literal\">-verb</span> runas <span class=\"string\">&quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\Powershell.exe&quot;</span>&#125;</span><br><span class=\"line\"><span class=\"built_in\">Set-Alias</span> su _su</span><br></pre></td></tr></table></figure>\n\n<p>输入su命令后会直接弹出一个新的具有管理员权限的powershell</p>\n<p><img src=\"/cn/posts/58638/image-20201114173232592.png\"></p>\n<h2 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h2><h3 id=\"cmd-提权：\"><a href=\"#cmd-提权：\" class=\"headerlink\" title=\"cmd 提权：\"></a>cmd 提权：</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">runas /user:hackett_yu@outlook.com cmd</span><br><span class=\"line\">doskey sudo=runas /user:&#123;$username&#125; cmd</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"快速进入命令行的方法\"><a href=\"#快速进入命令行的方法\" class=\"headerlink\" title=\"快速进入命令行的方法\"></a>快速进入命令行的方法</h3><p>如何从你的文件夹里快速打开命令行？请看下面</p>\n<p>1.将鼠标置于指定文件的空白处，按住Shift键的同时右击鼠标，这时在出来的右键菜单里会出现一个”打开命令行”  的菜—单选项，也有可能是“在此处打开Powershell窗口(s)”。这个具体和电脑个体设置有关。</p>\n<p>2.直接在指定目录的地址栏中输入<code>cmd</code>,即可进入命令行模式，同理输入powershell也可以</p>\n<p><img src=\"/cn/posts/58638/image-20201114173854864.png\" alt=\"image-20201114173854864\"></p>\n<p><img src=\"/cn/posts/58638/image-20201114173917127.png\" alt=\"image-20201114173917127\"></p>\n<p>3.安装Windows Terminal ，在应用商店即可下载。（在地址栏输入wt也可以快速调出，但是不会定位到当前目录）</p>\n<p><img src=\"/cn/posts/58638/image-20201114174133879.png\" alt=\"image-20201114174133879\"></p>\n","categories":[],"tags":[{"name":"Windows","path":"api/tags/Windows.json"}]}