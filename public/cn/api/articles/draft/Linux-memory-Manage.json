{"title":"Linux内存管理","slug":"draft/Linux-memory-Manage","date":"2020-11-13T04:27:41.000Z","updated":"2020-11-13T04:27:41.000Z","comments":true,"path":"api/articles/draft/Linux-memory-Manage.json","excerpt":"前言： 在 32 位的系统上，线性地址空间为 4GB，其中用户进程占有 3GB 线性地址空间，内核占有 1GB 线性地址空间。由于虚拟内存的引入，使的每个进程都可拥有 3GB 的虚拟内存。 用户进程的虚拟地址空间包含若干区域，这些区域的分布方式因体系结构的差异而不同，但所有的方式都包含下列成分： （1） 代码段：可执行文件的二进制代码 （2） 数据段：存储全局变量 （3） 栈：用于保存局部变量和实现函数调用 （4） 环境变量和命令行参数 （5） 程序使用的动态库的代码 （6） 用于映射文件内容的区域为便于描述，系统中进程的虚拟内存空间被划分为若干不同的区域，每个区域都有其相关的属性和用途，一个合法的地址总是落在某个区域当中的，这些区域也不会重叠。在 Linux 内核中，这样的区域被称为虚拟内存区域(virtual memory areas，VMA)。一个 VMA 是一块连续的线性地址空间的抽象，它拥有自身的权限(可读，可写，可执行等) ，对进程而言，VMA 其实是虚拟空间的内存块，一个进程的所有资源由多个内存块组成。 每一个虚拟内存区域都由一个相关的 struct vm_area_st","covers":["/cn/posts/53930/image-20200608163648953.png","/cn/posts/53930/image-20200608164250039.png","/cn/posts/53930/image-20200608164609038.png"],"content":"<blockquote>\n<p>前言：</p>\n<p>在 32 位的系统上，线性地址空间为 4GB，其中用户进程占有 3GB 线性地址空间，内核占有 1GB 线性地址空间。由于虚拟内存的引入，使的每个进程都可拥有 3GB 的虚拟内存。</p>\n<p>用户进程的虚拟地址空间包含若干区域，这些区域的分布方式因体系结构的差异而不同，但所有的方式都包含下列成分：</p>\n<p>（1） 代码段：可执行文件的二进制代码</p>\n<p>（2） 数据段：存储全局变量</p>\n<p>（3） 栈：用于保存局部变量和实现函数调用</p>\n<p>（4） 环境变量和命令行参数</p>\n<p>（5） 程序使用的动态库的代码</p>\n<p>（6） 用于映射文件内容的区域为便于描述，系统中进程的虚拟内存空间被划分为若干不同的区域，每个区域都有其相关的属性和用途，一个合法的地址总是落在某个区域当中的，这些区域也不会重叠。在 Linux 内核中，这样的区域被称为虚拟内存区域(virtual memory areas，VMA)。一个 VMA 是一块连续的线性地址空间的抽象，它拥有自身的权限(可读，可写，可执行等) ，对进程而言，VMA 其实是虚拟空间的内存块，一个进程的所有资源由多个内存块组成。</p>\n<p>每一个虚拟内存区域都由一个相关的 struct vm_area_struct 结构来描述。</p>\n<p>本文将编写一个内核模块，遍历一个用户进程中所有的 VMA，并且打印这些 VMA 的属性信息，如 VMA 的大小、起始地址等，并通过与“/proc/pid/maps”中显示的信息进行对比验证 VMA 信息是否正确。  </p>\n</blockquote>\n<ol>\n<li><h5 id=\"编写模块程序\"><a href=\"#编写模块程序\" class=\"headerlink\" title=\"编写模块程序\"></a>编写模块程序</h5><p>参考代码如下，代码文件命名为“vma_test.c”</p>\n</li>\n</ol>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//vma_test.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/module.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/init.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/mm.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/sched.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> pid;</span><br><span class=\"line\">module_param(pid, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">printit</span><span class=\"params\">(<span class=\"keyword\">struct</span> task_struct *tsk)</span></span><br><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">mm_struct</span> *<span class=\"title\">mm</span>;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">vm_area_struct</span> *<span class=\"title\">vma</span>;</span></span><br><span class=\"line\">  <span class=\"type\">int</span> j = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">long</span> start, end, length;</span><br><span class=\"line\"></span><br><span class=\"line\">  mm = tsk-&gt;mm;</span><br><span class=\"line\">  pr_info(<span class=\"string\">\"mm_struct addr = 0x%p\\n\"</span>, mm);</span><br><span class=\"line\">  vma = mm-&gt;mmap;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* 使用 mmap_sem 读写信号量进行保护 */</span></span><br><span class=\"line\">  down_read(&amp;mm-&gt;mmap_sem);</span><br><span class=\"line\">  pr_info(<span class=\"string\">\"vmas: vma start end length\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (vma) {</span><br><span class=\"line\">      j++;</span><br><span class=\"line\">      start = vma-&gt;vm_start;</span><br><span class=\"line\">      end = vma-&gt;vm_end;</span><br><span class=\"line\">      length = end - start;</span><br><span class=\"line\">      pr_info(<span class=\"string\">\"%6d: %16p %12lx %12lx %8ld\\n\"</span>,</span><br><span class=\"line\">          j, vma, start, end, length);</span><br><span class=\"line\">      vma = vma-&gt;vm_next;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  up_read(&amp;mm-&gt;mmap_sem);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __init <span class=\"title function_\">vma_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">{</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">task_struct</span> *<span class=\"title\">tsk</span>;</span></span><br><span class=\"line\">  <span class=\"comment\">/* 如果插入模块时未定义 pid 号，则使用当前 pid */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) {</span><br><span class=\"line\">      tsk = current;</span><br><span class=\"line\">      pid = current-&gt;pid;</span><br><span class=\"line\">      pr_info(<span class=\"string\">\"using current process\\n\"</span>);</span><br><span class=\"line\">  } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">      tsk = pid_task(find_vpid(pid), PIDTYPE_PID);</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!tsk)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  pr_info(<span class=\"string\">\" Examining vma's for pid=%d, command=%s\\n\"</span>, pid, tsk-&gt;comm);</span><br><span class=\"line\">  printit(tsk);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __exit <span class=\"title function_\">vma_exit</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">{</span><br><span class=\"line\">  pr_info(<span class=\"string\">\"Module exit\\n\"</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\">module_init(vma_init);</span><br><span class=\"line\">module_exit(vma_exit);</span><br><span class=\"line\"></span><br><span class=\"line\">MODULE_LICENSE(<span class=\"string\">\"GPL\"</span>);</span><br><span class=\"line\">MODULE_AUTHOR(<span class=\"string\">\"Mr Yu\"</span>);</span><br><span class=\"line\">MODULE_DESCRIPTION(<span class=\"string\">\"vma test\"</span>);</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>以上代码中:</p>\n<p>38-52 行是内核模块初始化函数 vma_init；</p>\n<p>40-46 行目的是获取 pid，可在加载模块时可传递相关参数（即进程 pid）；如果没有传递参数，则使用当前进程，即执行 insmod 命令的进程；</p>\n<p>45 行 pid_task()函数为获取任务的任务描述符信息，其返回值是 struct task_struct 结构体类型的变量；</p>\n<p>50 行调用自定义的 printit()函数打印相关信息；</p>\n<p>9-34 行是本实验核心函数；</p>\n<p>16 行获取待检查进程的内存描述符 struct mm_struct 数据结构，该结构由struct task_struct 中的*mm 指向；</p>\n<p>18 行获取 VMA 链表头，即 mm-&gt;mmap；</p>\n<p>21 行开始遍历 VMA 链表,down_read()函数用于申请读信号量，因本程序只是读取 VMA 链表，所以申请读者类型即可，若需丢 VMA 链表进行修改，则需申请写者类型信号量；  </p>\n<p>24-32 行遍历 VMA 链表，并对每个 VMA 打印其起始地址、终止地址和长度信<br>息；</p>\n<p>33 行释放读者信号量。</p>\n</blockquote>\n<ol start=\"2\">\n<li><h5 id=\"编译内核模块\"><a href=\"#编译内核模块\" class=\"headerlink\" title=\"编译内核模块\"></a>编译内核模块</h5><p>编写 Makefile 文件，文件名必须为“Makefile”  </p>\n<figure class=\"highlight makefile\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">obj-m := vma_test.o</span><br><span class=\"line\"></span><br><span class=\"line\">KERNELBUILD := /lib/modules/<span class=\"variable\">$(<span class=\"built_in\">shell</span> uname -r)</span>/build</span><br><span class=\"line\">CURRENT_PATH := <span class=\"variable\">$(<span class=\"built_in\">shell</span> pwd)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">all:</span></span><br><span class=\"line\">\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> modules</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">clean:</span></span><br><span class=\"line\">\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></tbody></table></figure></li>\n<li><h5 id=\"编译\"><a href=\"#编译\" class=\"headerlink\" title=\"编译\"></a>编译</h5><p>使用 make 命令编译即可。  </p>\n</li>\n<li><h5 id=\"插入模块\"><a href=\"#插入模块\" class=\"headerlink\" title=\"插入模块\"></a>插入模块</h5><p>先通过 top 命令查看进程，任意获取一个进程 pid，如图所示，  本例中获取apache2 进程的 pid 3509。  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/53930/image-20200608163648953.png\" alt=\"image-20200608163648953\"></p>\n<p>使 用 insmod 插 入 模 块 ， 并 传 参 。 如 图 所 示 ， 本 例 中 模 块 名 为“vma_test.ko”,pid 为 3509，则插入模块命令为：  </p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insmod vma_test.ko pid=3509</span><br></pre></td></tr></tbody></table></figure>\n\n<ol start=\"5\">\n<li><h5 id=\"查看程序打印信息\"><a href=\"#查看程序打印信息\" class=\"headerlink\" title=\"查看程序打印信息\"></a>查看程序打印信息</h5><p>通过 dmesg 命令查看 VMA 信息。如下图所示:</p>\n</li>\n</ol>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/53930/image-20200608164250039.png\" alt=\"image-20200608164250039\"></p>\n<blockquote>\n<p>从上图可看到 apache2 进程包含许多 VMA 区域，以第一个 VMA 区域为例，其起始地址为 0x564af2e3a000,结束地址为 564af2ed7000,长度为 643072 字节。  </p>\n</blockquote>\n<p>​    如下图所示为从 proc 虚拟文件系统中查看相应进程第一个 VMA 的完整信息。  </p>\n<p><img src= \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" data-lazy-src=\"/cn/posts/53930/image-20200608164609038.png\" alt=\"image-20200608164609038\"></p>\n<blockquote>\n<p>从以上两图中内容对比可知，本程序输出信息正确。  </p>\n</blockquote>\n","more":"<blockquote>\n<p>前言：</p>\n<p>在 32 位的系统上，线性地址空间为 4GB，其中用户进程占有 3GB 线性地址空间，内核占有 1GB 线性地址空间。由于虚拟内存的引入，使的每个进程都可拥有 3GB 的虚拟内存。</p>\n<p>用户进程的虚拟地址空间包含若干区域，这些区域的分布方式因体系结构的差异而不同，但所有的方式都包含下列成分：</p>\n<p>（1） 代码段：可执行文件的二进制代码</p>\n<p>（2） 数据段：存储全局变量</p>\n<p>（3） 栈：用于保存局部变量和实现函数调用</p>\n<p>（4） 环境变量和命令行参数</p>\n<p>（5） 程序使用的动态库的代码</p>\n<p>（6） 用于映射文件内容的区域为便于描述，系统中进程的虚拟内存空间被划分为若干不同的区域，每个区域都有其相关的属性和用途，一个合法的地址总是落在某个区域当中的，这些区域也不会重叠。在 Linux 内核中，这样的区域被称为虚拟内存区域(virtual memory areas，VMA)。一个 VMA 是一块连续的线性地址空间的抽象，它拥有自身的权限(可读，可写，可执行等) ，对进程而言，VMA 其实是虚拟空间的内存块，一个进程的所有资源由多个内存块组成。</p>\n<p>每一个虚拟内存区域都由一个相关的 struct vm_area_struct 结构来描述。</p>\n<p>本文将编写一个内核模块，遍历一个用户进程中所有的 VMA，并且打印这些 VMA 的属性信息，如 VMA 的大小、起始地址等，并通过与“/proc/pid/maps”中显示的信息进行对比验证 VMA 信息是否正确。  </p>\n</blockquote>\n<ol>\n<li><h5 id=\"编写模块程序\"><a href=\"#编写模块程序\" class=\"headerlink\" title=\"编写模块程序\"></a>编写模块程序</h5><p>参考代码如下，代码文件命名为“vma_test.c”</p>\n</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//vma_test.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/module.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/init.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/mm.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/sched.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> pid;</span><br><span class=\"line\">module_param(pid, <span class=\"type\">int</span>, <span class=\"number\">0644</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">printit</span><span class=\"params\">(<span class=\"keyword\">struct</span> task_struct *tsk)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">mm_struct</span> *<span class=\"title\">mm</span>;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">vm_area_struct</span> *<span class=\"title\">vma</span>;</span></span><br><span class=\"line\">  <span class=\"type\">int</span> j = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">long</span> start, end, length;</span><br><span class=\"line\"></span><br><span class=\"line\">  mm = tsk-&gt;mm;</span><br><span class=\"line\">  pr_info(<span class=\"string\">&quot;mm_struct addr = 0x%p\\n&quot;</span>, mm);</span><br><span class=\"line\">  vma = mm-&gt;mmap;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* 使用 mmap_sem 读写信号量进行保护 */</span></span><br><span class=\"line\">  down_read(&amp;mm-&gt;mmap_sem);</span><br><span class=\"line\">  pr_info(<span class=\"string\">&quot;vmas: vma start end length\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (vma) &#123;</span><br><span class=\"line\">      j++;</span><br><span class=\"line\">      start = vma-&gt;vm_start;</span><br><span class=\"line\">      end = vma-&gt;vm_end;</span><br><span class=\"line\">      length = end - start;</span><br><span class=\"line\">      pr_info(<span class=\"string\">&quot;%6d: %16p %12lx %12lx %8ld\\n&quot;</span>,</span><br><span class=\"line\">          j, vma, start, end, length);</span><br><span class=\"line\">      vma = vma-&gt;vm_next;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  up_read(&amp;mm-&gt;mmap_sem);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __init <span class=\"title function_\">vma_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">task_struct</span> *<span class=\"title\">tsk</span>;</span></span><br><span class=\"line\">  <span class=\"comment\">/* 如果插入模块时未定义 pid 号，则使用当前 pid */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      tsk = current;</span><br><span class=\"line\">      pid = current-&gt;pid;</span><br><span class=\"line\">      pr_info(<span class=\"string\">&quot;using current process\\n&quot;</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      tsk = pid_task(find_vpid(pid), PIDTYPE_PID);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!tsk)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  pr_info(<span class=\"string\">&quot; Examining vma&#x27;s for pid=%d, command=%s\\n&quot;</span>, pid, tsk-&gt;comm);</span><br><span class=\"line\">  printit(tsk);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __exit <span class=\"title function_\">vma_exit</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  pr_info(<span class=\"string\">&quot;Module exit\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">module_init(vma_init);</span><br><span class=\"line\">module_exit(vma_exit);</span><br><span class=\"line\"></span><br><span class=\"line\">MODULE_LICENSE(<span class=\"string\">&quot;GPL&quot;</span>);</span><br><span class=\"line\">MODULE_AUTHOR(<span class=\"string\">&quot;Mr Yu&quot;</span>);</span><br><span class=\"line\">MODULE_DESCRIPTION(<span class=\"string\">&quot;vma test&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>以上代码中:</p>\n<p>38-52 行是内核模块初始化函数 vma_init；</p>\n<p>40-46 行目的是获取 pid，可在加载模块时可传递相关参数（即进程 pid）；如果没有传递参数，则使用当前进程，即执行 insmod 命令的进程；</p>\n<p>45 行 pid_task()函数为获取任务的任务描述符信息，其返回值是 struct task_struct 结构体类型的变量；</p>\n<p>50 行调用自定义的 printit()函数打印相关信息；</p>\n<p>9-34 行是本实验核心函数；</p>\n<p>16 行获取待检查进程的内存描述符 struct mm_struct 数据结构，该结构由struct task_struct 中的*mm 指向；</p>\n<p>18 行获取 VMA 链表头，即 mm-&gt;mmap；</p>\n<p>21 行开始遍历 VMA 链表,down_read()函数用于申请读信号量，因本程序只是读取 VMA 链表，所以申请读者类型即可，若需丢 VMA 链表进行修改，则需申请写者类型信号量；  </p>\n<p>24-32 行遍历 VMA 链表，并对每个 VMA 打印其起始地址、终止地址和长度信<br>息；</p>\n<p>33 行释放读者信号量。</p>\n</blockquote>\n<ol start=\"2\">\n<li><h5 id=\"编译内核模块\"><a href=\"#编译内核模块\" class=\"headerlink\" title=\"编译内核模块\"></a>编译内核模块</h5><p>编写 Makefile 文件，文件名必须为“Makefile”  </p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">obj-m := vma_test.o</span><br><span class=\"line\"></span><br><span class=\"line\">KERNELBUILD := /lib/modules/<span class=\"variable\">$(<span class=\"built_in\">shell</span> uname -r)</span>/build</span><br><span class=\"line\">CURRENT_PATH := <span class=\"variable\">$(<span class=\"built_in\">shell</span> pwd)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">all:</span></span><br><span class=\"line\">\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> modules</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">clean:</span></span><br><span class=\"line\">\tmake -C <span class=\"variable\">$(KERNELBUILD)</span> M=<span class=\"variable\">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure></li>\n<li><h5 id=\"编译\"><a href=\"#编译\" class=\"headerlink\" title=\"编译\"></a>编译</h5><p>使用 make 命令编译即可。  </p>\n</li>\n<li><h5 id=\"插入模块\"><a href=\"#插入模块\" class=\"headerlink\" title=\"插入模块\"></a>插入模块</h5><p>先通过 top 命令查看进程，任意获取一个进程 pid，如图所示，  本例中获取apache2 进程的 pid 3509。  </p>\n<p><img src=\"/cn/posts/53930/image-20200608163648953.png\" alt=\"image-20200608163648953\"></p>\n<p>使 用 insmod 插 入 模 块 ， 并 传 参 。 如 图 所 示 ， 本 例 中 模 块 名 为“vma_test.ko”,pid 为 3509，则插入模块命令为：  </p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insmod vma_test.ko pid=3509</span><br></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li><h5 id=\"查看程序打印信息\"><a href=\"#查看程序打印信息\" class=\"headerlink\" title=\"查看程序打印信息\"></a>查看程序打印信息</h5><p>通过 dmesg 命令查看 VMA 信息。如下图所示:</p>\n</li>\n</ol>\n<p><img src=\"/cn/posts/53930/image-20200608164250039.png\" alt=\"image-20200608164250039\"></p>\n<blockquote>\n<p>从上图可看到 apache2 进程包含许多 VMA 区域，以第一个 VMA 区域为例，其起始地址为 0x564af2e3a000,结束地址为 564af2ed7000,长度为 643072 字节。  </p>\n</blockquote>\n<p>​    如下图所示为从 proc 虚拟文件系统中查看相应进程第一个 VMA 的完整信息。  </p>\n<p><img src=\"/cn/posts/53930/image-20200608164609038.png\" alt=\"image-20200608164609038\"></p>\n<blockquote>\n<p>从以上两图中内容对比可知，本程序输出信息正确。  </p>\n</blockquote>\n","categories":[],"tags":[{"name":"Linux","path":"api/tags/Linux.json"}]}